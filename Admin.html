<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Config Manager - Ican2233</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        input, select, textarea { transition: all 0.2s ease-in-out; }
        input:focus, select:focus, textarea:focus { border-color: #6366f1 !important; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[#0b0f1a] min-h-screen pb-20 text-slate-200">

    <div class="bg-indigo-600 p-6 shadow-2xl mb-6 rounded-b-[2.5rem] text-center border-b border-white/10">
        <h1 class="text-xl font-black tracking-tighter text-white uppercase italic">System Management</h1>
        <p id="activeRepoText" class="text-[9px] opacity-70 tracking-[0.3em] uppercase mt-1 text-indigo-100">Ican2233 Cloud Database</p>
    </div>

    <div class="max-w-md mx-auto px-4">
        
        <div class="glass-card p-6 rounded-[2rem] mb-6 shadow-xl">
            <div id="loginArea">
                <input type="password" id="ghToken" placeholder="GitHub Token (ghp_...)" class="w-full p-4 bg-black/40 border border-slate-700 rounded-2xl mb-4 outline-none text-sm text-emerald-400 font-mono">
                <button onclick="fetchAllRepos()" id="btnConnect" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-2xl font-black text-xs uppercase tracking-widest transition-all">Connect to GitHub</button>
            </div>

            <div id="selectorArea" class="hidden space-y-4 mt-4 pt-4 border-t border-white/5">
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 font-bold ml-2 uppercase">Repository</label>
                    <select id="repoSelect" onchange="fetchFiles()" class="w-full p-4 bg-slate-800 rounded-2xl font-bold text-sm border border-slate-700 outline-none appearance-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 font-bold ml-2 uppercase">File JSON</label>
                    <select id="fileSelect" class="w-full p-4 bg-slate-800 rounded-2xl font-bold text-sm border border-slate-700 outline-none appearance-none"></select>
                </div>
                <button onclick="loadJsonData()" class="w-full bg-white text-indigo-900 p-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-slate-100 active:scale-95 transition-all">Open Editor</button>
            </div>
        </div>

        <div id="editorArea" class="hidden">
            
            <div class="glass-card p-6 rounded-[2.5rem] shadow-2xl mb-8 border-t-4 border-indigo-500">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="formTitle" class="text-indigo-400 font-black text-xs uppercase tracking-widest">Editor</h2>
                    <span id="dataTypeBadge" class="text-[8px] bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-md font-bold uppercase">Object</span>
                </div>
                
                <div id="dynamicInputs" class="space-y-5">
                    </div>
                
                <div class="flex gap-3 mt-10">
                    <button onclick="saveChanges()" id="btnSave" class="flex-1 bg-indigo-600 text-white p-5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:bg-indigo-500 active:scale-95">Save Changes</button>
                    <button id="btnCancel" onclick="resetForm()" class="hidden bg-slate-700 text-white px-6 rounded-2xl font-bold text-xs uppercase">Cancel</button>
                </div>
            </div>

            <div id="listSection" class="hidden space-y-4">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-5 top-1/2 -translate-y-1/2 text-slate-500"></i>
                    <input type="text" id="searchInput" onkeyup="filterData()" placeholder="Search data..." class="w-full p-5 pl-14 bg-slate-900 rounded-2xl border border-slate-800 outline-none text-sm focus:border-indigo-500 shadow-xl">
                </div>
                <div id="itemsContainer" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        const OWNER = 'Ican2233';
        let allData = null;
        let isArray = false;
        let editIndex = -1;

        // Init
        window.onload = () => {
            const token = localStorage.getItem('ican_token');
            if(token) {
                document.getElementById('ghToken').value = token;
                fetchAllRepos();
            }
        };

        async function fetchAllRepos() {
            const token = document.getElementById('ghToken').value;
            try {
                const res = await fetch(`https://api.github.com/users/${OWNER}/repos?per_page=100&sort=updated`, {
                    headers: { Authorization: `token ${token}` }
                });
                const repos = await res.json();
                localStorage.setItem('ican_token', token);
                const select = document.getElementById('repoSelect');
                select.innerHTML = '<option value="">-- SELECT REPO --</option>';
                repos.forEach(r => select.innerHTML += `<option value="${r.name}">${r.name.toUpperCase()}</option>`);
                document.getElementById('selectorArea').classList.remove('hidden');
                document.getElementById('loginArea').classList.add('hidden');
            } catch (e) { alert("Invalid Token"); }
        }

        async function fetchFiles() {
            const token = localStorage.getItem('ican_token');
            const repo = document.getElementById('repoSelect').value;
            const res = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/`, {
                headers: { Authorization: `token ${token}` }
            });
            const files = await res.json();
            const select = document.getElementById('fileSelect');
            select.innerHTML = '<option value="">-- SELECT JSON FILE --</option>';
            files.filter(f => f.name.endsWith('.json')).forEach(f => select.innerHTML += `<option value="${f.name}">${f.name}</option>`);
        }

        async function loadJsonData() {
            const token = localStorage.getItem('ican_token');
            const repo = document.getElementById('repoSelect').value;
            const file = document.getElementById('fileSelect').value;
            const res = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                headers: { Authorization: `token ${token}` }, cache: 'no-store'
            });
            const data = await res.json();
            allData = JSON.parse(atob(data.content));
            isArray = Array.isArray(allData);

            document.getElementById('editorArea').classList.remove('hidden');
            document.getElementById('dataTypeBadge').innerText = isArray ? "Array / User List" : "Single Config";
            
            if(isArray) {
                document.getElementById('listSection').classList.remove('hidden');
                renderUserForm();
                renderList(allData);
            } else {
                document.getElementById('listSection').classList.add('hidden');
                renderConfigForm(allData);
            }
        }

        // --- RENDER UNTUK SINGLE CONFIG (Object) ---
        function renderConfigForm(obj, container = null, path = '') {
            const mainContainer = container || document.getElementById('dynamicInputs');
            if(!container) mainContainer.innerHTML = '';

            for (let key in obj) {
                const currentPath = path ? `${path}.${key}` : key;
                const value = obj[key];

                if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                    const group = document.createElement('div');
                    group.className = "p-4 bg-white/5 rounded-3xl border border-white/5 space-y-4 my-2";
                    group.innerHTML = `<label class="text-[10px] text-indigo-400 font-black uppercase tracking-widest pl-2">${key}</label>`;
                    mainContainer.appendChild(group);
                    renderConfigForm(value, group, currentPath);
                } else {
                    mainContainer.appendChild(createField(key, value, currentPath, 'config-field'));
                }
            }
        }

        // --- RENDER UNTUK USER LIST (Array) ---
        function renderUserForm() {
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = '';
            // Ambil template dari data pertama agar fieldnya sinkron
            const template = allData.length > 0 ? allData[0] : { id: "", username: "", password: "", expiresAt: "", allowOffline: false };
            for(let key in template) {
                container.appendChild(createField(key, '', key, 'user-field'));
            }
        }

        // --- HELPER BUAT FIELD INPUT ---
        function createField(key, value, path, className) {
            const div = document.createElement('div');
            div.className = "flex flex-col gap-1.5";
            let input = '';
            
            const isBool = typeof value === 'boolean' || key.toLowerCase().includes('allowoffline') || key.toLowerCase() === 'enabled' || key.toLowerCase() === 'mandatory';
            
            if (isBool) {
                input = `<select data-path="${path}" class="${className} w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl text-white outline-none">
                            <option value="false" ${value === false ? 'selected' : ''}>FALSE</option>
                            <option value="true" ${value === true ? 'selected' : ''}>TRUE</option>
                        </select>`;
            } else if (key === 'message' || key === 'description') {
                input = `<textarea data-path="${path}" rows="3" class="${className} w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl text-white outline-none">${value}</textarea>`;
            } else {
                const type = key.toLowerCase().includes('date') || key.toLowerCase().includes('expires') ? 'date' : 'text';
                input = `<input type="${type}" data-path="${path}" value="${value}" class="${className} w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl text-white outline-none">`;
            }

            div.innerHTML = `<label class="text-[9px] text-slate-500 font-bold uppercase ml-3">${key}</label>${input}`;
            return div;
        }

        // --- RENDER LIST KARTU ---
        function renderList(data) {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';
            data.forEach((item, index) => {
                const originalIdx = allData.indexOf(item);
                let details = '';
                for(let k in item) details += `<div class="flex justify-between text-[10px] py-1 border-b border-white/5"><span class="text-slate-500 uppercase">${k}</span><span class="text-indigo-300 font-mono truncate ml-4">${item[k]}</span></div>`;
                
                container.innerHTML += `
                <div class="glass-card p-5 rounded-[2rem] border border-white/5 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <div class="truncate"><h3 class="text-lg font-black text-white italic uppercase">${item.username || item.name || 'USER'}</h3></div>
                        <div class="flex gap-2">
                            <button onclick="editItem(${originalIdx})" class="w-10 h-10 rounded-xl bg-indigo-500/10 text-indigo-400 flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteItem(${originalIdx})" class="w-10 h-10 rounded-xl bg-red-500/10 text-red-400 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="bg-black/20 p-4 rounded-2xl">${details}</div>
                </div>`;
            });
        }

        // --- LOGIKA SIMPAN ---
        async function saveChanges() {
            const btn = document.getElementById('btnSave');
            btn.disabled = true; btn.innerText = "SAVING...";

            if (isArray) {
                let newItem = {};
                document.querySelectorAll('.user-field').forEach(f => {
                    const key = f.getAttribute('data-path');
                    let val = f.value;
                    if(val === 'true') val = true; else if(val === 'false') val = false;
                    newItem[key] = val;
                });
                if(editIndex > -1) allData[editIndex] = newItem; else allData.push(newItem);
            } else {
                document.querySelectorAll('.config-field').forEach(f => {
                    const path = f.getAttribute('data-path').split('.');
                    let val = f.value;
                    if(val === 'true') val = true; else if(val === 'false') val = false;
                    
                    let ref = allData;
                    for(let i=0; i < path.length - 1; i++) ref = ref[path[i]];
                    ref[path[path.length - 1]] = val;
                });
            }

            await pushToGitHub();
            btn.disabled = false; btn.innerText = "SAVE CHANGES";
            resetForm();
        }

        async function pushToGitHub() {
            const token = localStorage.getItem('ican_token');
            const repo = document.getElementById('repoSelect').value;
            const file = document.getElementById('fileSelect').value;
            const resSha = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, { headers: { Authorization: `token ${token}` } });
            const shaData = await resSha.json();
            
            await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Update via Manager",
                    content: btoa(JSON.stringify(allData, null, 2)),
                    sha: shaData.sha
                })
            });
            alert("Updated Successfully!");
            loadJsonData();
        }

        function editItem(idx) {
            editIndex = idx;
            const item = allData[idx];
            document.querySelectorAll('.user-field').forEach(f => {
                const key = f.getAttribute('data-path');
                f.value = String(item[key] || '');
            });
            document.getElementById('btnCancel').classList.remove('hidden');
            document.getElementById('formTitle').innerText = "Edit Mode";
            window.scrollTo({top: 400, behavior: 'smooth'});
        }

        function deleteItem(idx) {
            if(confirm("Delete this record?")) { allData.splice(idx, 1); pushToGitHub(); }
        }

        function resetForm() {
            editIndex = -1;
            document.querySelectorAll('.user-field').forEach(f => f.value = '');
            document.getElementById('btnCancel').classList.add('hidden');
            document.getElementById('formTitle').innerText = "Editor";
        }

        function filterData() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(item => Object.values(item).some(v => String(v).toLowerCase().includes(q)));
            renderList(filtered);
        }
    </script>
</body>
</html>
