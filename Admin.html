<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Manager - Ican2233</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0b0f1a; color: #e2e8f0; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .input-focus:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); }
        select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.2em; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div class="bg-indigo-600 p-8 shadow-2xl mb-8 rounded-b-[3rem] text-center border-b border-white/10">
        <h1 class="text-2xl font-black tracking-tighter text-white uppercase italic">Global System Editor</h1>
        <p id="statusPath" class="text-[9px] opacity-70 tracking-[0.3em] uppercase mt-2 text-indigo-100">Ready to Connect</p>
    </div>

    <div class="max-w-md mx-auto px-5">
        
        <div class="glass p-6 rounded-[2.5rem] mb-6 shadow-xl">
            <div id="authArea">
                <label class="text-[10px] text-indigo-400 font-bold uppercase ml-2 mb-2 block">GitHub Personal Token</label>
                <input type="password" id="ghToken" placeholder="ghp_..." class="w-full p-4 bg-black/30 border border-slate-700 rounded-2xl mb-4 outline-none text-emerald-400 font-mono text-sm">
                <button onclick="connectGitHub()" id="btnConnect" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-black text-xs uppercase tracking-widest transition-all active:scale-95">Connect Account</button>
            </div>

            <div id="pickerArea" class="hidden space-y-4">
                <div>
                    <label class="text-[9px] text-slate-500 font-bold uppercase ml-2">Select Repository</label>
                    <select id="repoSelect" onchange="fetchFiles()" class="w-full p-4 bg-slate-800/50 border border-slate-700 rounded-2xl text-sm font-bold outline-none mt-1"></select>
                </div>
                <div>
                    <label class="text-[9px] text-slate-500 font-bold uppercase ml-2">Select JSON File</label>
                    <select id="fileSelect" class="w-full p-4 bg-slate-800/50 border border-slate-700 rounded-2xl text-sm font-bold outline-none mt-1"></select>
                </div>
                <button onclick="loadContent()" class="w-full bg-white text-indigo-900 p-4 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Open Editor</button>
            </div>
        </div>

        <div id="editorPanel" class="hidden animate-in fade-in duration-500">
            <div class="glass p-6 rounded-[2.5rem] shadow-2xl border-t-4 border-indigo-500 mb-8">
                <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                    <h2 id="editorTitle" class="text-indigo-400 font-black text-xs uppercase tracking-widest">Editor</h2>
                    <span id="typeTag" class="text-[8px] bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded font-bold uppercase">Object</span>
                </div>

                <div id="formFields" class="space-y-5"></div>

                <div class="flex gap-3 mt-10">
                    <button onclick="pushUpdate()" id="btnSave" class="flex-1 bg-indigo-600 text-white p-5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95">Push to GitHub</button>
                    <button id="btnCancel" onclick="resetUserForm()" class="hidden bg-slate-700 text-white px-6 rounded-2xl font-bold text-xs uppercase">Cancel</button>
                </div>
            </div>

            <div id="listPanel" class="hidden space-y-4">
                <div class="relative mb-6">
                    <i class="fa-solid fa-magnifying-glass absolute left-5 top-1/2 -translate-y-1/2 text-slate-500"></i>
                    <input type="text" id="searchBar" onkeyup="filterList()" placeholder="Quick search..." class="w-full p-5 pl-14 bg-slate-900/80 rounded-2xl border border-slate-800 outline-none text-sm focus:border-indigo-500 shadow-xl">
                </div>
                <div id="cardContainer" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        let OWNER = 'Ican2233';
        let allData = null;
        let isArrayMode = false;
        let currentEditIdx = -1;

        // --- AUTH & FETCH ---
        async function connectGitHub() {
            const token = document.getElementById('ghToken').value;
            try {
                const res = await fetch(`https://api.github.com/users/${OWNER}/repos?sort=updated`, {
                    headers: { Authorization: `token ${token}` }
                });
                if(!res.ok) throw new Error();
                const repos = await res.json();
                localStorage.setItem('gh_token', token);
                
                const select = document.getElementById('repoSelect');
                select.innerHTML = repos.map(r => `<option value="${r.name}">${r.name.toUpperCase()}</option>`).join('');
                document.getElementById('authArea').classList.add('hidden');
                document.getElementById('pickerArea').classList.remove('hidden');
                fetchFiles();
            } catch (e) { alert("Token Salah!"); }
        }

        async function fetchFiles() {
            const token = localStorage.getItem('gh_token');
            const repo = document.getElementById('repoSelect').value;
            const res = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/`, {
                headers: { Authorization: `token ${token}` }
            });
            const files = await res.json();
            document.getElementById('fileSelect').innerHTML = files
                .filter(f => f.name.endsWith('.json'))
                .map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        async function loadContent() {
            const token = localStorage.getItem('gh_token');
            const repo = document.getElementById('repoSelect').value;
            const file = document.getElementById('fileSelect').value;
            const res = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                headers: { Authorization: `token ${token}` }, cache: 'no-store'
            });
            const raw = await res.json();
            allData = JSON.parse(atob(raw.content));
            isArrayMode = Array.isArray(allData);

            document.getElementById('editorPanel').classList.remove('hidden');
            document.getElementById('typeTag').innerText = isArrayMode ? "Array / User List" : "Nested Object / Config";
            document.getElementById('statusPath').innerText = `${repo} > ${file}`;
            
            refreshUI();
        }

        function refreshUI() {
            const container = document.getElementById('formFields');
            container.innerHTML = '';
            
            if (isArrayMode) {
                document.getElementById('listPanel').classList.remove('hidden');
                buildArrayForm();
                renderCards(allData);
            } else {
                document.getElementById('listPanel').classList.add('hidden');
                buildRecursiveForm(allData, container);
            }
        }

        // --- FORM BUILDERS ---
        function buildRecursiveForm(obj, container, path = '') {
            for (let key in obj) {
                const fullPath = path ? `${path}.${key}` : key;
                const val = obj[key];

                if (typeof val === 'object' && val !== null && !Array.isArray(val)) {
                    // Create folder-like section for Nested Objects
                    const section = document.createElement('div');
                    section.className = "p-4 bg-indigo-500/5 rounded-3xl border border-indigo-500/10 space-y-4 my-2";
                    section.innerHTML = `<label class="text-[10px] text-indigo-400 font-black uppercase tracking-widest pl-2">${key}</label>`;
                    container.appendChild(section);
                    buildRecursiveForm(val, section, fullPath);
                } else if (Array.isArray(val)) {
                    // Handler for simple lists like socialLinks
                    const listDiv = document.createElement('div');
                    listDiv.className = "p-4 bg-slate-800/30 rounded-3xl space-y-3";
                    listDiv.innerHTML = `<label class="text-[10px] text-slate-500 font-bold uppercase pl-2">${key} (List)</label>`;
                    val.forEach((item, i) => buildRecursiveForm(item, listDiv, `${fullPath}.${i}`));
                    container.appendChild(listDiv);
                } else {
                    container.appendChild(createInput(key, val, fullPath, 'config-input'));
                }
            }
        }

        function buildArrayForm() {
            const container = document.getElementById('formFields');
            const template = allData.length > 0 ? allData[0] : { username: "", password: "", expiresAt: "", allowOffline: false };
            for(let key in template) {
                container.appendChild(createInput(key, '', key, 'user-input'));
            }
        }

        function createInput(key, val, path, cls) {
            const div = document.createElement('div');
            div.className = "flex flex-col gap-1.5";
            
            // Logika Deteksi Tipe Input
            const isBool = (typeof val === 'boolean' || ['enabled', 'mandatory', 'allowoffline'].some(s => key.toLowerCase().includes(s)));
            let input = '';

            if (isBool) {
                input = `<select data-path="${path}" class="${cls} w-full p-4 bg-slate-800/80 border border-slate-700 rounded-2xl outline-none text-white">
                    <option value="false" ${val === false ? 'selected' : ''}>FALSE (OFF)</option>
                    <option value="true" ${val === true ? 'selected' : ''}>TRUE (ON)</option>
                </select>`;
            } else if (key.toLowerCase() === 'message') {
                input = `<textarea data-path="${path}" rows="3" class="${cls} w-full p-4 bg-slate-800/80 border border-slate-700 rounded-2xl outline-none text-white">${val}</textarea>`;
            } else {
                const type = key.toLowerCase().includes('date') || key.toLowerCase().includes('expires') ? 'date' : 'text';
                input = `<input type="${type}" data-path="${path}" value="${val}" class="${cls} w-full p-4 bg-slate-800/80 border border-slate-700 rounded-2xl outline-none text-white input-focus">`;
            }

            div.innerHTML = `<label class="text-[9px] text-slate-500 font-bold uppercase ml-3">${key}</label>${input}`;
            return div;
        }

        // --- LIST RENDER ---
        function renderCards(data) {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            data.forEach((item, index) => {
                const originalIdx = allData.indexOf(item);
                let info = '';
                for(let k in item) info += `<div class="flex justify-between text-[10px] py-1 border-b border-white/5"><span class="text-slate-500 uppercase">${k}</span><span class="text-indigo-300 font-mono truncate ml-4">${item[k]}</span></div>`;
                
                container.innerHTML += `
                <div class="glass p-5 rounded-[2rem] border border-white/5 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-black text-white italic uppercase truncate">${item.username || item.name || 'DATA'}</h3>
                        <div class="flex gap-2">
                            <button onclick="editRow(${originalIdx})" class="w-10 h-10 rounded-xl bg-indigo-500/10 text-indigo-400 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteRow(${originalIdx})" class="w-10 h-10 rounded-xl bg-red-500/10 text-red-400 flex items-center justify-center hover:bg-red-600 hover:text-white transition-all"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="bg-black/20 p-4 rounded-2xl">${info}</div>
                </div>`;
            });
        }

        // --- CORE LOGIC: PUSH & SAVE ---
        async function pushUpdate() {
            const btn = document.getElementById('btnSave');
            btn.disabled = true; btn.innerText = "SINKRONISASI...";

            if (isArrayMode) {
                // Logic for User List (Array)
                let newItem = {};
                document.querySelectorAll('.user-input').forEach(i => {
                    const key = i.getAttribute('data-path');
                    let val = i.value;
                    if(val === 'true') val = true; else if(val === 'false') val = false;
                    newItem[key] = val;
                });
                if(currentEditIdx > -1) allData[currentEditIdx] = newItem; else allData.push(newItem);
            } else {
                // Logic for Update Dialog (Nested Object)
                document.querySelectorAll('.config-input').forEach(i => {
                    const path = i.getAttribute('data-path').split('.');
                    let val = i.value;
                    if(val === 'true') val = true; else if(val === 'false') val = false;

                    // Deep nesting navigation
                    let ref = allData;
                    for(let k=0; k < path.length - 1; k++) {
                        ref = ref[path[k]];
                    }
                    ref[path[path.length - 1]] = val;
                });
            }

            try {
                const token = localStorage.getItem('gh_token');
                const repo = document.getElementById('repoSelect').value;
                const file = document.getElementById('fileSelect').value;
                
                const getSha = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, { headers: { Authorization: `token ${token}` } });
                const shaData = await getSha.json();

                const push = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                    method: 'PUT',
                    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Cloud Update: " + file,
                        content: btoa(JSON.stringify(allData, null, 2)),
                        sha: shaData.sha
                    })
                });

                if(push.ok) alert("✅ Data Berhasil Diperbarui!");
                else alert("❌ Gagal Push ke GitHub!");
                loadContent();
            } catch (e) { alert("Error!"); }
            finally {
                btn.disabled = false; btn.innerText = "PUSH TO GITHUB";
                resetUserForm();
            }
        }

        function editRow(idx) {
            currentEditIdx = idx;
            const item = allData[idx];
            document.querySelectorAll('.user-input').forEach(i => {
                const key = i.getAttribute('data-path');
                i.value = String(item[key] || '');
            });
            document.getElementById('btnCancel').classList.remove('hidden');
            document.getElementById('editorTitle').innerText = "Edit User Mode";
            window.scrollTo({top: 400, behavior: 'smooth'});
        }

        function deleteRow(idx) {
            if(confirm("Hapus data ini?")) { allData.splice(idx, 1); pushUpdate(); }
        }

        function resetUserForm() {
            currentEditIdx = -1;
            document.querySelectorAll('.user-input').forEach(i => i.value = '');
            document.getElementById('btnCancel').classList.add('hidden');
            document.getElementById('editorTitle').innerText = "Editor";
        }

        function filterList() {
            const q = document.getElementById('searchBar').value.toLowerCase();
            const filtered = allData.filter(item => Object.values(item).some(v => String(v).toLowerCase().includes(q)));
            renderCards(filtered);
        }

        // Auto Load Token if exist
        window.onload = () => {
            const t = localStorage.getItem('gh_token');
            if(t) { document.getElementById('ghToken').value = t; connectGitHub(); }
        }
    </script>
</body>
</html>
