<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Ican2233</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-900 min-h-screen pb-10 font-sans text-slate-200">
    <div class="bg-gradient-to-r from-indigo-600 to-blue-700 p-6 shadow-2xl mb-6 rounded-b-[3rem] border-b-4 border-blue-400">
        <h1 class="text-2xl font-black text-center tracking-tighter italic">SUPER ADMIN PANEL</h1>
        <p class="text-[10px] text-center opacity-70 tracking-[0.3em] uppercase mt-1">Ican2233 Global Control</p>
    </div>

    <div class="max-w-md mx-auto px-4">
        <div class="bg-slate-800 p-5 rounded-3xl shadow-xl mb-6 border border-slate-700">
            <h2 class="text-blue-400 font-bold text-xs mb-3 uppercase tracking-widest"><i class="fa-solid fa-shuttle-space mr-2"></i>Koneksi GitHub</h2>
            <input type="password" id="ghToken" placeholder="Masukkan Token ghp_..." class="w-full p-4 bg-slate-900 border border-slate-700 rounded-2xl mb-3 outline-none text-sm text-blue-300 focus:border-blue-500 transition">
            <button onclick="fetchAllRepos()" class="w-full bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-2xl font-black text-xs transition active:scale-95 shadow-lg uppercase">Hubungkan Akun</button>
        </div>

        <div id="selectorArea" class="hidden space-y-3 mb-6 animate-fade-in text-slate-900">
            <select id="repoSelect" onchange="fetchFiles()" class="w-full p-4 bg-white rounded-2xl font-bold text-sm shadow-inner outline-none border-2 border-blue-500"></select>
            <select id="fileSelect" class="w-full p-4 bg-white rounded-2xl font-bold text-sm shadow-inner outline-none border-2 border-indigo-500"></select>
            <button onclick="loadJsonData()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-black text-xs shadow-lg uppercase tracking-widest">Buka Database</button>
        </div>

        <div id="editorArea" class="hidden bg-slate-800 p-5 rounded-3xl shadow-xl mb-6 border-t-4 border-green-500">
            <h2 id="formTitle" class="text-green-400 font-bold text-xs mb-4 uppercase tracking-widest">Tambah User Baru</h2>
            <div class="space-y-3">
                <input type="hidden" id="editIndex" value="-1">
                <input type="text" id="deviceId" placeholder="ID Device" class="w-full p-4 bg-slate-900 rounded-2xl outline-none text-sm border border-slate-700 text-white">
                <input type="text" id="username" placeholder="Username" class="w-full p-4 bg-slate-900 rounded-2xl outline-none text-sm border border-slate-700 text-white">
                <input type="text" id="password" placeholder="Password" class="w-full p-4 bg-slate-900 rounded-2xl outline-none text-sm border border-slate-700 text-white">
                <input type="date" id="expiresAt" class="w-full p-4 bg-slate-900 rounded-2xl outline-none text-sm border border-slate-700 text-white uppercase">
                <label class="flex items-center space-x-3 p-4 bg-slate-900 rounded-2xl cursor-pointer border border-slate-700">
                    <input type="checkbox" id="allowOffline" class="w-5 h-5 rounded border-slate-700 text-blue-600">
                    <span class="text-sm text-slate-400 uppercase font-bold text-[10px]">Allow Offline</span>
                </label>
                <div class="flex gap-2 pt-2">
                    <button onclick="saveData()" id="btnSave" class="flex-1 bg-green-600 text-white p-4 rounded-2xl font-black text-xs shadow-md uppercase">Simpan</button>
                    <button id="btnCancel" onclick="resetForm()" class="hidden bg-slate-600 text-white p-4 rounded-2xl font-black text-xs uppercase">Batal</button>
                </div>
            </div>
        </div>

        <div id="dataArea" class="hidden">
            <h3 class="font-black text-slate-500 mb-4 px-2 text-[10px] uppercase tracking-[0.3em] flex justify-between items-center">
                User List <span id="count" class="bg-slate-700 text-blue-400 px-3 py-1 rounded-full text-[10px] border border-slate-600">0</span>
            </h3>
            <div id="userList" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const OWNER = 'Ican2233';
        let allData = [];
        let currentSHA = '';

        async function fetchAllRepos() {
            const token = document.getElementById('ghToken').value;
            if(!token) return alert("Masukkan Token!");
            
            try {
                const res = await fetch(`https://api.github.com/users/${OWNER}/repos?per_page=100`, {
                    headers: { Authorization: `token ${token}` }
                });
                const repos = await res.json();
                const select = document.getElementById('repoSelect');
                select.innerHTML = '<option value="">-- PILIH REPOSITORY --</option>';
                repos.forEach(r => select.innerHTML += `<option value="${r.name}">${r.name.toUpperCase()}</option>`);
                document.getElementById('selectorArea').classList.remove('hidden');
                alert("Akun Terhubung!");
            } catch (e) { alert("Token Salah!"); }
        }

        async function fetchFiles() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('repoSelect').value;
            if(!repo) return;

            try {
                const res = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/`, {
                    headers: { Authorization: `token ${token}` }
                });
                const files = await res.json();
                const select = document.getElementById('fileSelect');
                select.innerHTML = '<option value="">-- PILIH FILE JSON --</option>';
                files.filter(f => f.name.endsWith('.json')).forEach(f => {
                    select.innerHTML += `<option value="${f.name}">${f.name}</option>`;
                });
            } catch (e) { alert("Gagal mengambil file."); }
        }

        async function loadJsonData() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('repoSelect').value;
            const file = document.getElementById('fileSelect').value;
            if(!file) return alert("Pilih file dulu!");

            try {
                const res = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                    headers: { Authorization: `token ${token}` },
                    cache: 'no-store'
                });
                const data = await res.json();
                currentSHA = data.sha;
                allData = JSON.parse(atob(data.content));
                renderUsers();
                document.getElementById('editorArea').classList.remove('hidden');
                document.getElementById('dataArea').classList.remove('hidden');
            } catch (e) { alert("Format JSON tidak didukung atau file kosong."); }
        }

        function renderUsers() {
            const list = document.getElementById('userList');
            document.getElementById('count').innerText = allData.length;
            list.innerHTML = '';
            allData.forEach((u, i) => {
                const card = document.createElement('div');
                card.className = "bg-slate-800 p-5 rounded-[2rem] border border-slate-700 flex justify-between items-center shadow-lg";
                card.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="text-[8px] font-mono text-blue-500 font-bold uppercase truncate opacity-60 mb-1">${u.id || 'NO_ID'}</div>
                        <div class="font-black text-white text-lg tracking-tight">${u.username}</div>
                        <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-1">Exp: ${u.expiresAt}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editMode(${i})" class="bg-indigo-500/20 text-indigo-400 w-12 h-12 rounded-2xl border border-indigo-500/30 flex items-center justify-center"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteData(${i})" class="bg-red-500/20 text-red-400 w-12 h-12 rounded-2xl border border-red-500/30 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function editMode(i) {
            const u = allData[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('deviceId').value = u.id || "";
            document.getElementById('username').value = u.username;
            document.getElementById('password').value = u.password;
            document.getElementById('expiresAt').value = u.expiresAt;
            document.getElementById('allowOffline').checked = u.allowOffline;
            document.getElementById('formTitle').innerText = "EDIT USER: " + u.username;
            document.getElementById('btnSave').innerText = "UPDATE DATA";
            document.getElementById('btnCancel').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function resetForm() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('deviceId').value = "";
            document.getElementById('username').value = "";
            document.getElementById('password').value = "";
            document.getElementById('expiresAt').value = "";
            document.getElementById('allowOffline').checked = false;
            document.getElementById('formTitle').innerText = "TAMBAH USER BARU";
            document.getElementById('btnSave').innerText = "SIMPAN";
            document.getElementById('btnCancel').classList.add('hidden');
        }

        async function saveData() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('repoSelect').value;
            const file = document.getElementById('fileSelect').value;
            const index = parseInt(document.getElementById('editIndex').value);

            const user = {
                id: document.getElementById('deviceId').value || "dev_" + Math.random().toString(36).substr(2, 5),
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                expiresAt: document.getElementById('expiresAt').value,
                allowOffline: document.getElementById('allowOffline').checked
            };

            if(!user.username || !token) return alert("Isi Data!");
            
            try {
                // Get latest SHA
                const resSha = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                    headers: { Authorization: `token ${token}` }
                });
                const dataSha = await resSha.json();

                if(index === -1) allData.push(user); else allData[index] = user;

                const update = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                    method: 'PUT',
                    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Admin Update",
                        content: btoa(JSON.stringify(allData, null, 2)),
                        sha: dataSha.sha
                    })
                });

                if(update.ok) { alert("Berhasil Terupdate!"); resetForm(); loadJsonData(); }
            } catch (e) { alert("Gagal Simpan!"); }
        }

        async function deleteData(i) {
            if(!confirm("Hapus?")) return;
            allData.splice(i, 1);
            saveDataManual();
        }

        async function saveDataManual() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('repoSelect').value;
            const file = document.getElementById('fileSelect').value;
            const resSha = await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                headers: { Authorization: `token ${token}` }
            });
            const dataSha = await resSha.json();
            await fetch(`https://api.github.com/repos/${OWNER}/${repo}/contents/${file}`, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Delete user",
                    content: btoa(JSON.stringify(allData, null, 2)),
                    sha: dataSha.sha
                })
            });
            loadJsonData();
        }
    </script>
</body>
</html>
